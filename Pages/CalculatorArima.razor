@page "/calculator-arima"
@using Models
@inject RandomData _arima
<h1>ARIMA Model prediction</h1>
<h6>Choose date to predict currency rate changes:</h6>
<RadzenDatePicker @bind-Value=@timeTo DateFormat="d" Style="margin-bottom: 20px;"></RadzenDatePicker>
@if (CheckDate())
{
    <h6>Now tell us what currency to track:</h6>
    <RadzenListBox AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Multiple="true"
    Data=currencyList @bind-Value=currencyValues Style="margin-bottom: 20px; display: block;" />
    <RadzenButton Text="Get Data!" Click="@(args => Plot())" Style="margin-bottom: 20px;" />
    @if (isDataLoaded)
    {
        <h2>Currency rates for @string.Join(", ", currencyValues)</h2>
        <span>I want it to be smooth!</span>
        <Chart Data=data></Chart>
    }
    else
    {
        if(data != null)
        {
            <h2>Loading...</h2>
        }
    }
}
else
{
    <h3>You have to choose next days only.</h3>
}

@code {
    DateTime timeFrom = DateTime.Now.Date.AddDays(-5);
    DateTime timeTo = DateTime.Now.Date.AddDays(10);
    bool isSmooth = false;
    bool isDataLoaded = false;
    IEnumerable<string> currencyValues = new string[] { "USD" };
    IEnumerable<string> currencyList = new string[] { "USD", "EUR" };
    List<DataSet> data;

    bool CheckDate()
    {
        return true;
    }
    void Plot()
    {
        GetData();
    }

    async void GetData()
    {
        isDataLoaded = false;
        data = new List<DataSet>();
        data.Clear();
        var d = await _arima.GetData(timeFrom, timeTo, currencyValues);
        foreach(var key in d.Keys)
        {
            var dataSet = new DataSet() {CurrencyName = key, Items = new List<DataItem>()};
            foreach(var kkey in d[key].Keys)
            {
                var date = kkey.FromTimestamp();
                dataSet.Items.Add(new DataItem() {Date = date, CurrencyRate = d[key][kkey]});
                Console.WriteLine(d[key][kkey]);
            }
            data.Add(dataSet);
        }

        isDataLoaded = true;
        StateHasChanged();
    }
}